<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="atom.xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://lewisblog.github.io/blog</id>
    <title>Lewis Website Blog</title>
    <updated>2024-12-29T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://lewisblog.github.io/blog"/>
    <subtitle>Lewis Website Blog</subtitle>
    <icon>https://lewisblog.github.io/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Power BI Data Model - Best Practice Analyzer (BPA)]]></title>
        <id>https://lewisblog.github.io/blog/pbi-bpa-rules</id>
        <link href="https://lewisblog.github.io/blog/pbi-bpa-rules"/>
        <updated>2024-12-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Knowing general best practices for the PBI data model optimization, such as avoiding bi-directional relationships, reducing the column cardinality, avoiding DirectQuery whenever possible, or removing Auto Date/Time hidden tables, still remains the key requirement! But, Tabular Editor may help you quickly and easily identify potential violations of these practices — based on the insight gained, you can then decide if you want to apply the recommended practice(s) or keep your original data modeling logic in place through Best Practice Analyzer (BPA) tools.]]></summary>
        <content type="html"><![CDATA[<p>Knowing general best practices for the PBI data model optimization, such as avoiding bi-directional relationships, reducing the column cardinality, avoiding DirectQuery whenever possible, or removing Auto Date/Time hidden tables, still remains the key requirement! But, Tabular Editor may help you quickly and easily identify potential violations of these practices — based on the insight gained, you can then decide if you want to apply the recommended practice(s) or keep your original data modeling logic in place through Best Practice Analyzer (BPA) tools.</p>
<p><em>And the best thing is that you can run BPA rules on your .bim file prior to CICD deployment to make sure the deployment is validated.</em></p>
<p>For example:</p>
<ul>
<li>Do not use floating point data types</li>
<li>Don’t summarize numeric columns</li>
</ul>
<h1>Working with BPA Rules</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="load-bpa-rules">Load BPA Rules<a href="https://lewisblog.github.io/blog/pbi-bpa-rules#load-bpa-rules" class="hash-link" aria-label="Direct link to Load BPA Rules" title="Direct link to Load BPA Rules">​</a></h2>
<p>We can download the list of default BPA rules from this github (link) then import directly into tabular editor exe.</p>
<ol>
<li>To load the BPA rules, select the C# Script tab.</li>
<li>Paste in the following script.</li>
</ol>]]></content>
        <author>
            <name>Lewis Quoc Quang</name>
            <uri>https://www.linkedin.com/in/trinh-quoc-quang/</uri>
        </author>
        <category label="Data Governanace" term="Data Governanace"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Multitable SCD2 Joins - How to Unify Historical Changes]]></title>
        <id>https://lewisblog.github.io/blog/multitable-scd2-joins</id>
        <link href="https://lewisblog.github.io/blog/multitable-scd2-joins"/>
        <updated>2024-12-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In the realm of data management, historical changes are conventionally stored in separate Slowly Changing Dimension Type 2 (SCD2) tables. However, extracting point-in-time insights from these dispersed sources requires merging them into a single, unified entity.]]></summary>
        <content type="html"><![CDATA[<p>In the realm of data management, historical changes are conventionally stored in separate Slowly Changing Dimension Type 2 (SCD2) tables. However, extracting point-in-time insights from these dispersed sources requires merging them into a single, unified entity.</p>
<p>This guide offers a succinct walkthrough of the process for performing multitable SCD2 joins, presenting two distinct approaches, Direct Join and Unified Timeline, evaluating their respective advantages and drawbacks through practical examples.</p>
<p>Let’s see how to effectively unify historical data and derive valuable insights</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="intent">Intent<a href="https://lewisblog.github.io/blog/multitable-scd2-joins#intent" class="hash-link" aria-label="Direct link to Intent" title="Direct link to Intent">​</a></h2>
<p>In data warehousing, Slowly Changing Dimension Type 2 (SCD2) tables are widely used to track historical changes in dimension data. However, joining SCD2 tables correctly requires a specific approach to ensure accurate results. This article provides an understanding of the challenges involved and a step-by-step guide to implement robust joins for SCD2 tables.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="problem">Problem<a href="https://lewisblog.github.io/blog/multitable-scd2-joins#problem" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem">​</a></h2>
<p>Why is joining SCD2 tables challenging?
SCD2 tables are designed to maintain historical data by creating new rows with updated attributes and validity periods. This introduces two main challenges:</p>
<ul>
<li>Temporal Overlap: The same business key can exist in multiple rows, each representing a different validity period.</li>
<li>Point-in-Time Accuracy: Joining two SCD2 tables must align rows that were valid at the same point in time to ensure accurate results.
A naive join may result in duplications or mismatched records due to overlapping validity periods.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution">Solution<a href="https://lewisblog.github.io/blog/multitable-scd2-joins#solution" class="hash-link" aria-label="Direct link to Solution" title="Direct link to Solution">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="method-1-direct-join-with-02-scd2-tables">Method 1: Direct Join with 02 SCD2 tables<a href="https://lewisblog.github.io/blog/multitable-scd2-joins#method-1-direct-join-with-02-scd2-tables" class="hash-link" aria-label="Direct link to Method 1: Direct Join with 02 SCD2 tables" title="Direct link to Method 1: Direct Join with 02 SCD2 tables">​</a></h3>
<ol>
<li>Perform this join condition that enables merging 2 rows that are in the same validity period</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> scd2_table1 t1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> scd2_table2 t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>Recalculate <code>valid_from</code> &amp; <code>valid_to</code></li>
</ol>
<ul>
<li><code>valid_from</code> should be the latest one of the 2 <code>valid_from</code> of the 2 tables</li>
<li><code>valid_to</code> should be the earliest one of the 2 <code>valid_to</code> of the 2 tables</li>
</ul>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">greatest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1900-01-01'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lead</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">greatest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1900-01-01'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">over</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">partition</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">order</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> greatest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1900-01-01'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">'9999-12-31'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> valid_to</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>Filter out rows with <code>valid_from = valid_to</code> after join to avoid duplicated validity intervals</li>
</ol>
<p>In most of real-life examples, <code>valid_from</code> and <code>valid_to</code> are usually in lower time granularity like timestamp (with the differences down to seconds), hence there might not be cases where these column value “overlapped” across multiple SCD2 tables and we might skip this step. However, for an overall solution, this should be a part of your joining condition.</p>
<ol start="4">
<li>Combine them all together</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prep1 </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dim1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dim2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            greatest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1900-01-01'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lead</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">greatest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1900-01-01'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">over</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">partition</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">order</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> greatest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1900-01-01'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token string" style="color:#e3116c">'9999-12-31'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> valid_to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> scd2_table1 t1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> scd2_table2 t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> prep1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> valid_from </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> valid_to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">order</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> PK</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="method-2-unified-timeline">Method 2: Unified timeline<a href="https://lewisblog.github.io/blog/multitable-scd2-joins#method-2-unified-timeline" class="hash-link" aria-label="Direct link to Method 2: Unified timeline" title="Direct link to Method 2: Unified timeline">​</a></h3>
<p>This approach to multitable SCD2 joins first creates a unified timeline based on all the <code>valid_from</code> from referenced SCD2s. This timeline will be used as a scaffold for joining back all the SCD2s later on. Unlike Direct Join, the deduplication &amp; <code>valid_to</code> recalculation steps are done during timeline unification. This allows us to execute all SCD2 joins in 1 CTE instead.</p>
<p>Note that the process is quite similar when joining 02, 03 or more SCD2s:</p>
<ul>
<li>Union PKs, <code>valid_from</code> from subsequent SCD2s;</li>
<li>Deduplicate the unioned table to make the following calculation lighter;</li>
<li>Recalculate <code>valid_to</code> from the unioned data to create the timeline;</li>
<li>Join subsequent SCD2s back to the timeline using this condition below. Repeat for all SCD2s.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="unified-timeline--code-snippets">Unified timeline – Code Snippets<a href="https://lewisblog.github.io/blog/multitable-scd2-joins#unified-timeline--code-snippets" class="hash-link" aria-label="Direct link to Unified timeline – Code Snippets" title="Direct link to Unified timeline – Code Snippets">​</a></h4>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unified_timeline </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- using union to deal with duplicates values instead of union all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_from </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> scd2_table1 </span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_from </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> scd2_table2 </span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_from </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> scd2_table3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unified_timeline_recalculate_valid_to </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lead</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">over</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">partition</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> pk </span><span class="token keyword" style="color:#00009f">order</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> valid_from</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'9999-12-31'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> valid_to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            valid_to </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'9999-12-31'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> is_current</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> unified_timeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    joined </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scd2_table1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dim1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scd2_table2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dim2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scd2_table3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dim3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1900-01-01'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">coalesce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'9999-12-31'</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> valid_to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> unified_timeline_recalculate_valid_to </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> timeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">left</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> scd2_table1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scd2_table1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> scd2_table1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> scd2_table1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">left</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> scd2_table2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scd2_table2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> scd2_table2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> scd2_table2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">left</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> scd2_table3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scd2_table1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pk </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> scd2_table3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_from </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> scd2_table3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> timeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> joined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- where valid_from != valid_to -- As we already have a distinct timeline (using union), this condition is no longer needed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">order</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> PK</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim3</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pros-and-cons-of-two-methods-for-joining-scd2-tables">Pros and Cons of Two Methods for Joining SCD2 Tables<a href="https://lewisblog.github.io/blog/multitable-scd2-joins#pros-and-cons-of-two-methods-for-joining-scd2-tables" class="hash-link" aria-label="Direct link to Pros and Cons of Two Methods for Joining SCD2 Tables" title="Direct link to Pros and Cons of Two Methods for Joining SCD2 Tables">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="direct-joins">Direct Joins<a href="https://lewisblog.github.io/blog/multitable-scd2-joins#direct-joins" class="hash-link" aria-label="Direct link to Direct Joins" title="Direct link to Direct Joins">​</a></h3>
<table><thead><tr><th><strong>Pros</strong></th><th><strong>Cons</strong></th></tr></thead><tbody><tr><td>Simple to implement and understand.</td><td>Can result in incorrect joins if overlapping validity periods exist.</td></tr><tr><td>Efficient for small datasets.</td><td>Requires careful handling of <code>valid_to</code> (e.g., NULL values).</td></tr><tr><td>No need for pre-processing.</td><td>May fail to align records accurately in complex scenarios.</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="unified-timeline-method">Unified Timeline Method<a href="https://lewisblog.github.io/blog/multitable-scd2-joins#unified-timeline-method" class="hash-link" aria-label="Direct link to Unified Timeline Method" title="Direct link to Unified Timeline Method">​</a></h3>
<table><thead><tr><th><strong>Pros</strong></th><th><strong>Cons</strong></th></tr></thead><tbody><tr><td>Ensures accurate alignment of records across tables.</td><td>More complex to implement and requires additional processing.</td></tr><tr><td>Handles overlapping validity periods effectively.</td><td>May require significant compute resources for large datasets.</td></tr><tr><td>Suitable for point-in-time analysis and historical consistency.</td><td>Slightly slower due to timeline unification steps.</td></tr></tbody></table>
<p>By following these steps, you can reliably join SCD2 tables while maintaining historical and point-in-time accuracy. Proper implementation ensures accurate data analysis and minimizes the risk of logical errors in your data pipeline.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://lewisblog.github.io/blog/multitable-scd2-joins#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<ul>
<li><strong>Problem</strong>: Joining SCD2 tables can be challenging due to overlapping validity periods and the need for point-in-time accuracy.</li>
<li><strong>Solution</strong>: To address this, filter records using the valid_from and valid_to columns and perform a temporal join based on both business keys and validity periods.</li>
<li><strong>Implementation</strong>: The solution is implemented using SQL, with a focus on defining a point-in-time context, filtering valid records, and aligning temporal validity.</li>
<li><strong>Comparison of Methods</strong>:<!-- -->
<ul>
<li>Direct Joins: Simple to implement but prone to errors with overlapping periods.</li>
<li>Unified Timeline Method: Ensures accuracy but is more complex and resource-intensive.</li>
</ul>
</li>
</ul>]]></content>
        <author>
            <name>Lewis Quoc Quang</name>
            <uri>https://www.linkedin.com/in/trinh-quoc-quang/</uri>
        </author>
        <category label="Data Model" term="Data Model"/>
    </entry>
</feed>